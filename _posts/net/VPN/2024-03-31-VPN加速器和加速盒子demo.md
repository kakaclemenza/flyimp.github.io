---
typora-root-url: ../../../
---



### 一. 前言

经过一个多月的探究, XXMYGW小组大致摸清了业界加速器实现的方法, 同时, 也做出了几个demo给各位读者体验. 本文的目的主要介绍这几个demo的使用方法, 原理; 最终目的是探讨如何把这个加速器的功能推进上线, 为公司网络产品提供更好的代理加速体验. 各位大佬可以尽情提问吐槽.

本文涉及到的专业名词:

* VPN: 全称虚拟专用网络, 大家理解为在原有物理链路上构建的一个局域网即可
* OpenVPN: 用来构建VPN的一个跨平台开源软件
* 树莓派: 一个小型的计算机设备, 常用于安装linux发行版实现各种硬件控制相关操作
* openwrt: 一个linux发行版, 常用于路由器设备.
* 加速器软件: 集成了OpenVPN功能的一个客户端软件或sdk
* 加速盒子: 集成了OpenVPN功能的一个路由器设备



### 二. 加速器软件demo(Android版)

##### 网盘链接: 

加速器软件: https://t.2980.com/54KVY

##### 使用测试方法: 

(1) Android手机安装"加速器软件demo.apk", 手机切换到4G网络

(2) 打开, 此时会弹出VPN连接创建请求, 请点击"确定"来允许该软件创建VPN连接

![vpn_demo_1](/img/net/VPN/vpn_demo_1.jpg)

(3) 点击"Ping"测试下. 等待一会, 在"未加速"一栏会显示测速结果, 访问海外ip: 112.73.0.3网络质量不佳.

![vpn_demo_2](/img/net/VPN/vpn_demo_2.jpg)

(4) 点击"Accel", 看到状态信息显示"accelerate success"加速成功.

(5) 再次点击"Ping"测试下. 等待一会, 在"已加速"一栏会显示测速结果, 访问海外ip: 112.73.0.3网络质量大大改善.

![vpn_demo_3](/img/net/VPN/vpn_demo_3.jpg)

##### 原理分析:



##### 当前demo局限: 

* 仅实现了对于指定一个或多个ip做加速. 要实现全局代理加速需要android进一步优化
* 更用户友好的实现是允许用户指定应用程序来加速, Android端已有方案, 未实现
* 仅支持Android和linux平台, 其他平台需要相关人员参与开发



### 三. 加速盒子demo

##### 网盘链接: 

- 固件: https://t.2980.com/S4kWW
- 加速盒子客户端(Android): https://t.2980.com/K58XP

##### 使用测试方法: 

(1) 下载openwrt固件, 使用dd工具写入64M以上的sd卡中.

(2) 将sd卡插入树莓派3b+设备, 启动树莓派即可. 

(3) 稍等片刻, 手机搜索可以看到名为"xxmygwvpn"的wifi热点已经可以连接. 点击连接该热点, 密码是"xiaofeng"

(4) 连上后, 此时VPN隧道并没有创建, 所有网络流量其实是默认的网关出口. 可以测试访问google.com, 是访问不了的.

(5) 安装加速盒子客户端, 打开后如下图. 

![vpn_demo_4](/img/net/VPN/vpn_demo_4.jpg)

(6) 点击"加速"按钮. 看到显示"accelerate success"加速成功.

![vpn_demo_5](/img/net/VPN/vpn_demo_5.jpg)

(7) 此时所有网络流量会走VPN隧道, 从中山国际线路出口. 测试已经可以访问google.com



##### 原理分析:



##### 当前demo局限: 

* 特殊硬件盒子设备需要特殊的自定义编译openwrt来支持. 当前仅支持树莓派3b+
* 加速盒子客户端仅支持Android. 但由于它是简单的tcp客户端, 跨平台支持其实很方便.



### 四. VPN方式与现有nat转发方式优劣分析

VPN方式可以完全替代现有的nat转发方式, 来实现代理. 由于它区别于nat转发方式的组网模式, 它也适用于p2p加速支持. 除此之外, 它提供了更大的网络优化的可能性.

#### 优势

* 解耦业务依赖: 不需要配置特殊的nat转发规则, 这意味着服务端再也不用和xxmygw服交互, 这也意味着单机游戏客户端能轻松通过VPN方式来实现"多人联机"模式. (类似"蒲公英联机平台")
* 客户端使用简单: 无论是安装app, 还是集成sdk, 都只要求客户端点击一下"申请加速"操作即可. 客户端不需要换ip重新连, 甚至后面能实现自动切换线路逻辑也可以让sdk来控制.
* 更大的网络优化可能性: VPN方式下, 客户端到服务端的隧道可以在用户态完全控制, 可以使用一定的传输优化方法比如FEC编码, 多路复用smux等. 而代理点到目标服这段也可以方便进行SDN网络优化

#### 劣势

* 无法隐藏公网ip: 仅提供公网ip的业务, 需要自行做负载均衡策略, 对抗DDos攻击. 公司游戏业务则可以选择只使用私网ip来连接服务器.
* 单点转发流量存在上限: 一台4核8G CPU型号为Intel Xeon E5-2643 v3 @ 3.40GHz的虚机, 上限转发包速率约为150Mbps左右. 这个数值可以通过调整源码来进行进一步优化
* 隧道组包解包会增加一定的数据包延迟: 未评测, 预估<5ms



### 五. VPN加速后网络的改变

(1) 用户真实出口ip的获取: 这点不再通过xxmygw和服务器交互来告知业务服, 目标是将xxmygw与业务服完全解耦合. 加速申请时xxmygw会返回给客户端它的出口ip, 业务服想知道客户端的出口ip, 需要由客户端发起协议告知业务服.

(2) 加速前后tcp连接断开问题: 加速前后由于tcp连接四元组改变, 旧tcp连接必定会失效引发tcp重连, 而**udp连接则不会这样**. 关于重连逻辑的处理, 需要业务服客户端和服务端另外协商策略. **客户端发起加速申请成功后, 理应立即发起tcp重新建立连接流程**

(3) 关于token用于保障链路安全问题: token作用应该是告知服务端, 该客户端ip改变为代理ip的动作是合法的. 其实这个意义不大, 客户端完全可以在登录业务服时就自行保留相关密钥或token, 或者要发起加速申请前, 先找服务端获得实时的密钥或toke, 等到加速申请成功后, 用该密钥或token作为验证客户端身份的证据. (这点需要再和安全小组讨论下)



### 六. 对标产品

#### 加速器软件

* 网易UU加速器: https://uu.163.com/
* 蒲公英联机平台: https://pgy.oray.com/

#### 加速盒子

* 网易UU加速盒: https://uu.163.com/box/
* Redmi路由器AC2100: https://www.mi.com/rm2100/specs