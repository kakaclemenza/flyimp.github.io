---
layout: post
title: 虚拟网络互联
category: net
tag: basic
---

### 互联模式

##### 网桥二层互联实现

```
   h1 --- bridge1 --- bridge2 --- h3
             |           |
             |           |
             h2          h4
```

这个网络中, 各个主机的ip配置如下:

- h1: 10.0.0.1/24
- h2: 10.0.1.1/24
- h3: 10.0.0.2/24
- h4: 10.0.1.2/24

这里故意将(1)不同网段配置在同一个网桥下, (2)相同网段配置在不同网桥下, 主要用于验证网桥仅是二层设备, arp协议是可以正常广播的.

一开始h1与h3能ping通, h2和h4能ping通, 其他的都无法ping通. h1和h2之间无法ping通是因为从h1发出的包无法匹配本地路由表, 因为h1上没有配置10.0.1.0/24网段的路由, 也没有默认路由, 所以无法发出. 另外h2上也没有配置10.0.0.0/24网段的路由, 所以即使收到h1的ping包了, 也无法成功发送回复包. 各自加上就可以连通了

```shell
# h1上加上10.0.1.0/24网段的路由
route add -net 10.0.1.0/24 h1-eth0
# h2上加上10.0.0.0/24网段的路由
route add -net 10.0.0.0/24 h2-eth0
```



##### bridge+vlan二层互联实现

```
   h1 --- bridge1 --- bridge2 --- h3
             |           |
             |           |
             h2          h4
```

bridge可以实现互联的同时隔离冲突域, 而vlan可以用来隔离广播域, 实现租户隔离, 两者的结合就可以模拟物理交换机的全部功能.

配置vlan:

* 安装

  ```shell
  apt-get install vlan
  modprobe 8021q
  lsmod | grep -i 8021q 
  ```

* 添加vlan虚拟网卡, 则凡是通过这张网卡出去的数据包都会自动在以太网数据帧的目的MAC地址和源MAC地址字段之后、协议类型字段之前加入4个字节的VLAN标签, 然后在发送出去

  ```shell
  # 添加vlan网卡: 添加vlan id=10虚拟网卡
  vconfig add eth0 10
  
  # 删除
  vconfig rem eth0.10
  ```

* 通常将 vlan 虚拟网卡直接与 bridge 相连, 可以实现同一子网出口打上vlan tag.
* ovs中vlan的配置要直接操作流表, 比较复杂, 不如**直接使用vxlan方便**.

##### 交换机+网关路由器三层组网实现

```
h1 --- bridge1 --- router --- router --- bridge2 --- h3
          |                                 |
          |                                 |
          h2                                h4
```



##### 虚拟大二层网络组网实现

vxlan

```
                h2 --- ovs3 --- h3
                      /    \
                     /      \
                 vxlan2   vxlan3
                  /           \
                 /             \
            vxlan2            vxlan3 ------
              /                           |
             /                            |
   h1 --- ovs1 --- vxlan1 --- vxlan1 --- ovs2 --- h3
           |                                 |
           |                                 |
           h2                                h4
```



### 实际跨地域互联

广域网的ovs间互联, 目前所知, 只能通过隧道方式实现.

gre不足：

　　1.点对点，所有的计算节点和网络节点都会建立GRE Tunnel，规模扩大，效率极其的低下

　　2.扩大的广播域，GRE不支持组播，一个网络（GRE Tunnel ID一样）中的一个vm发出广播帧后，GRE 会将其广播到所有与该节点有隧道连接的节点。

　　3.GRE 封装的IP包的过滤和负载均衡问题

​    目前还是有很多的防火墙和三层网络设备无法解析 GRE Header，因此它们无法对 GRE 封装包做合适的过滤和负载均衡。 


