---
layout: post
title: 编译和链接
category: flyos
---

### CPU总线

我们知道冯诺依曼体系结构的计算机由五大部件组成: 运算器, 控制器, 存储器, 输入设备, 输出设备. 一般CPU中集成了运算器, 控制器, 所以总线就是用来连接这些CPU与存储器和IO设备的导线, 

按照计算机所传输的信息种类，计算机的总线可以划分为

* 数据总线： 数据总线DB是双向三态形式的总线，即它既可以把CPU的数据传送到存储器或输入输出接口等其它部件，也可以将其它部件的数据传送到CPU。数据总线的位数是微型计算机的一个重要指标，通常与微处理的字长相一致。我们说的32位，64位计算机指的就是数据总线。
* 地址总线： 地址总线AB是专门用来传送地址的，由于地址只能从CPU传向外部存储器或I/O端口，所以地址总线总是单向三态的，这与数据总线不同。地址总线的位数决定了CPU可直接寻址的内存空间大小。
* 控制总线：控制总线主要用来传送控制信号和时序信号。控制总线的传送方向由具体控制信号而定，一般是双向的，控制总线的位数要根据系统的实际控制需要而定。其实数据总线和控制总线可以共用。

注意: 以上介绍的都是最早的计算机结构, 而现代计算机结构中, 总线的已经被南北桥芯片替代, 有些计算机设计中为了提升数据传输效率, 甚至直接将南北桥芯片功能集成进CPU.

### CPU读写内存或IO设备过程

1. CPU 内部通过cs:ip取指令. 指令含义是读取内存到寄存器, 则内部地址加法器合成内存地址(实模式下)
2. 将内存地址放到地址总线
3. 控制总线使能MEMR信号
4. 此时内存设备中的内存控制器收到信号, 识别为读内存操作, 就从地址总线获取地址, 并将该地址处内容放到数据总线上.
5. CPU再从数据总线获取到需要的数据, 放入寄存器.

如果是**启用分页机制**, 则CPU会把要访问内存地址(此时是**虚拟内存地址**)发给MMU, MMU再映射出实际的物理内存地址放到地址总线.

### CPU读写IO设备过程

IO编址方式:

* Memory-mapped I/O (MMIO): MMIO中，内存和I/O设备共享同一个地址空间。 MMIO是应用得最为广泛的一种IO方法，它使用相同的地址总线来处理内存和I/O设备，I/O设备的内存和寄存器被映射到与之相关联的地址。当CPU访问某个内存地址时，它可能是物理内存，也可以是某个I/O设备的内存。因此，用于访问内存的CPU指令也可来访问I/O设备。每个I/O设备监视CPU的地址总线，一旦CPU访问分配给它的地址，它就做出响应，将数据总线连接到需要访问的设备硬件寄存器。为了容纳I/O设备，CPU必须预留给I/O一个地址区域，该地址区域不能给物理内存使用。

  ![PMIO](/img/flyos/mmio.png)

* Port-mapped I/O (PMIO): 在PMIO中，内存和I/O设备有各自的地址空间(称: IO地址空间)。 端口映射I/O通常使用一种特殊的CPU指令，专门执行I/O操作。在Intel的微处理器中，使用的指令是IN和OUT。这些指令可以读/写1,2,4个字节(例如：outb, outw, outl)从/到IO设备上。I/O设备有一个与内存不同的地址空间，为了实现地址空间的隔离，**要么在CPU物理接口上增加一个I/O引脚，要么增加一条专用的I/O总线**。由于I/O地址空间与内存地址空间是隔离的，所以有时将PMIO称为被隔离的IO(Isolated I/O)。

  ![PMIO](/img/flyos/pmio.png)

在intel CPU架构中部分的采用了PMIO，又部分的采用了MMIO。以下介绍PMIO



### Cache

cache是SRAM, 一种静态存储器, 速度快功耗低但价格贵, 一般就是**集成在CPU内部**, 大小几十K~几十M不等, 分多级. Cache一般会将CPU当前**需求的内存处之后的一块连续内存**同时读取放到Cache中, 如果cache命中, 就会大大提高运算效率

