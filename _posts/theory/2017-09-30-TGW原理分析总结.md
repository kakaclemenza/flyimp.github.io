---
layout: post
title: TGW调查总结
category: thoughts
---

### 一. 动机初衷
&emsp; 通过分析 TGW 的用法, 接入过程. 以及官网所有的一些原理介绍文档, 推测TGW的实现详情, 改善 XXMYGW   

### 二. 精确的就近接入
#### 就近接入实现: GSLB
&emsp; GSLB, 全局服务负载均衡, 它实现了在互联网上不同地域的服务器间的流量调配，保证使用最佳的服务器服务离自己最近的客户，从而确保访问质量。  
&emsp; 目前GSLB的实现方式有4种: 基于DNS、基于HTTP重定向、基于IP路由，以及其它方式。其中基于DNS方式的实现虽然具有很好的扩展性和通用性, 但是解析精度依赖于LocalDNS能否准确代码客户端的位置. 其他实现方式也各有优缺点, 详细可参考: [GSLB调研](https://blog.goquxiao.com/posts/2015/11/22/gslb-research-1/)

#### GSLB 没解决的问题: 域名劫持
伪造LocalDNS欺骗客户端, 导致目标域名被恶意解析到其他IP地址.

#### 业界解决方案: HTTPDNS

HttpDNS主要解决三类问题：

1. LocalDNS劫持
2. 平均访问延迟下降
3. 用户连接失败率下降

**LocalDNS劫持**: 由于HttpDNS是通过ip直接请求http获取服务器A记录地址，不存在向本地运营商询问domain解析过程，所以从根本避免了劫持问题。 （对于http内容tcp/ip层劫持，可以使用验证因子或者数据加密等方式来保证传输数据的可信度）

**平均访问延迟下降**: 由于是ip直接访问省掉了一次domain解析过程，（即使系统有缓存速度也会稍快一些‘毫秒级’）通过智能算法排序后找到最快节点进行访问。

**用户连接失败率下降**: 通过算法降低以往失败率过高的服务器排序，通过时间近期访问过的数据提高服务器排序，通过历史访问成功记录提高服务器排序。如果ip(a)访问错误，在下一次返回ip(b)或者ip(c) 排序后的记录。（LocalDNS很可能在一个ttl时间内（或多个ttl）都是返回记录

![httpdns](/img/httpdns.png)   
这个说白了没什么, 直接按ip访问HTTPDNS服务器, 将域名作为参数传给它, 由它去按最优策略查找要解析的域名, 如:   
&emsp;&emsp;[向114Dns解析域名www.MyDemo.com](http://119.29.29.29/d?dn=www.MyDemo.com)   
这样的做法可以成功解决域名劫持问题, 并且HTTPDNS上的查询策略保证精确的就近接入.   

PS: 如果XXMYGW要对外提供服务, 可以考虑也像这样搭建一些httpdns服务器. 接入简单   
&emsp; 如果不需要, 维持目前"同运营商距离最近"也是相同的策略, 但要自行保证解析准确性

ref: `https://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&mid=209805123&idx=1&sn=ced8d67c3e2cc3ca38ef722949fa21f8&3rd=MzA3MDU4NTYzMw==&scene=6`

ref: [PowerDNS](https://github.com/PowerDNS/pdns)

### 三. TGW实现推演
#### 统一网关的好处:
* 收敛IP
* 攻击阻隔
* 负载均衡

#### 租户隔离
TGW为了在软件层面实现租户隔离, 在内网都是使用隧道方式+自研VPC私有网络. 请求全过程如:
![IP隧道+VPC](/img/tgw1.png)   
在上图右侧可以看到同一个租户分配一个**VPCID**，在VPC内，客户可以自由组网，租户网络本身就是隔离的，具体的处理由vpc.ko内核模块来实现. 关于实现租户隔离的更多内容不是目前重点.

[2019-02-11] vpcid的实现原理应该和vlan_id的是类似的. 两者都是为了实现租户隔离. vlan_id可以保证使用方只识别具有统一vlan_id标记的数据包.

#### NAT映射
1. 对于具有公网IP的实例(qcloud.com上的信息)   
[猜测实现方式为]: SNAT(静态地址转换)
&emsp;"公有 IP 地址是可以从 Internet 访问的 IP 地址，可以使用公用 IP 地址在实例和 Internet 之间进行通信。公有 IP 地址通过网络地址转换 (NAT) 映射到实例的私有 IP 地址. 腾讯云的所有公网接口统一由 Tencent Gateway（TGW）进行处理，TGW 具有可靠性高、扩展性强、性能高、抗攻击能力强等特点，提供了更加高效和安全的网络访问。因此，腾讯云云服务器实例的公网网卡在统一接口层 TGW 上配置，云服务器无感知。"   
&emsp;从以上引用可以看出, 每个从腾讯云购买的实例, 其网卡是配置在TGW上的. 请求通过就近接入到达TGW, TGW使用SNAT将公网IP转换为分配的私网IP, 然后通过私网IP将请求交给真实的服务器处理   

2. 对于无公网IP的实例(wiki.open.qq.com上的信息)   
[猜测实现方式]: 域名转化为私网ip
![腾讯开放平台TGW云服务接入](/img/tgw2.png)   
按上图接入方案及相关调查, 无公网IP的实例接入TGW主要用于HTTP协议及类HTTP的协议. 通过Host字段知道私网服务器绑定的域名, 通过域名-私网IP对照表可以查出私网的IP, 然后通过私网IP将请求交给真实的服务器处理.    

PS: 具体TGW如何实现高效转发就存在了多种可能: 
* TGW没有做 
* 类似我们将实现的:利用内核连接跟踪机制 
* 未知的解决方案

#### 负载均衡CLB
负载均衡技术应该是与ipvs一样的或直接利用ipvs

#### 抗DDos
具体实现是：CLB在接收到客户端的三步握手请求时，代理三步握手，在数据包到来之前，不会打扰到RS，一旦第一个包到来，CLB将其缓存，此时再和RS进行三步握手，握手成功之后，将缓存的数据包发送给RS，之后的流程就透传数据包了。这样保证DDos攻击不会到达RS，而是由CLB来承担压力。CLB本身承载能力比较强，又是集群模式，同时又具备资源隔离的能力，所以一般情况下，很难在10s以内把CLB机器压垮。   
![抗DDos](/img/tgw3.png)   

### 四. 完整接入过程模拟
参考上面"抗DDos"一图, 推测应有如下过程:
1. 用户按域名发起请求
2. 域名解析, 获得最近同运营商IP
3. 向最近tgw发出请求包
4. tgw与用户进行三次握手
5. tgw缓存第一个数据包, 按'用户ip/域名'查表得到私网ip
6. tgw根据获得的私网ip, 与私网服务器进行三次握手
7. 补发缓存的数据包
8. 至此建立连接跟踪, 后续原理上按连接规则修改ip, 进行透传即可
