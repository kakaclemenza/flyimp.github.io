---
layout: post
title: 各平台特殊支持记录
category: app
typora-root-url: ../../../..
---

## 前言

对日常开发golang sdk过程中各平台的特殊问题解决方案记录。

## 问题解决记录

1. **Q：**windows平台使用sdk后，调用`system()`调用直接返回没有效果？
   **原因：**sdk依赖`golang.org/x/net`库在 v0.1.0 以下版本时，干扰到了`system()`调用导致该调用执行后无效。
   **解决：**升级`golang.org/x/net`库到 v0.1.0 及以上版本（同时也依要求go1.17以上版本）。
2. **Q：**windows平台unity引擎加载sdk后，重启unity编辑器会导致编译卡住问题
   **原因：**golang协程调度模型对于新创建的线程不会关闭，而是放入线程池备用；unity编辑器要求在运行结束后关闭所有新开的线程，否则就会持续等待线程关闭，导致重启编译时卡住。
   **解决：**
   * 尝试定位golang多余线程产生原因，防止sdk产生多余的未关闭线程。【X】失败；深入golang源码，发现多余线程的产生方式多种多样，想要方式产生多余线程改动会很大。
   * 探究是否可以sdk导出方法，彻底关闭golang运行时。【X】可以彻底关闭golang运行时，但是unity仍然卡编译；推测问题是在于unity本身。
   * 排除法，定位sdk代码中引起unity卡住的代码，发现只有sdk新建的线程回调unity C#代码后，才会卡编译。【Y】进一步查看网上说法和mono的源码，确定该问题。解决方案详见[unity引擎接入sdk.md]()
3. **Q：**ios平台arm64库真机运行崩溃。
   **原因：**使用云平台真机测试发现，go1.17以上版本x/net库cgo编译出来的arm指令存在平台不兼容问题，运行后必崩。
   **解决：**暂时回退到go1.13版本就不会有这个问题。
4. **Q：**cgo环境下崩溃问题如何定位？
   **原因：**cgo环境下，崩溃堆栈C和go的格式是不相同的，目前如果在C代码中崩溃了，就输出的是C的堆栈，看不到go堆栈；如果是在go代码线程中崩溃了，则相反。
   **解决：**当前先利用各平台标准错误输出重定向的功能，将golang崩溃堆栈输出到崩溃文件中，用以定位golang崩溃问题；而对于C堆栈崩溃问题定位，**预计可以利用coredump文件，有待进一步验证**。
5. **Q：**mingw-w64在linux下编译的x86动态库，会依赖于`libgcc_s_dw2-1.dll`，部分机器没有该库会出现加载sdk失败error=193。
   **原因：**
   **解决：**连接时，加入`CGO_LDFLAGS='-static-libgcc'`将该库静态连接，去除外部依赖。
6. **Q：**armeabi-v7a库在安卓x86模拟器中，加载直接崩溃，崩溃堆栈在libhoudini.so中，报错地址一般为`0xdead0000`？
   **原因：**libhoudini用于将arm指令翻译为x86指令，使得安卓模拟器能正常高速的在x86架构CPU上运行，但该模块闭源且基本不再维护更新。go1.11及以上版本使用的arm汇编指令变动较大，导致libhoudini模块无法正常翻译指令引起崩溃。
   **解决：**使用go1.10版本编译armeabi-v7a库，兼容处理。
7. **Q：**win平台调用FreeLibrary()会崩溃？
   **原因：**golang运行时需要和进程生命周期相同，因此相关的库不能卸载，否则就会导致内存访问异常。
   **解决：**golang内部调用GetModuleHandleExA()多次绑定动态库文件，不释放。参考[issues/11100](https://github.com/golang/go/issues/11100)
8. **Q：**Android 10+写入日志文件报错：permission denied
   **原因：**Android 10+之后的安全管控加紧，不允许直接写入外部存储卡。
   **解决：**根据规范要求位置和方式，来写入日志。
9. **Q：**
   **原因：**
   **解决：**
10. **Q：**
    **原因：**
    **解决：**
11. **Q：**
    **原因：**
    **解决：**
12. **Q：**
    **原因：**
    **解决：**



