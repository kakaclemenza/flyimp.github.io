---
layout: post
title: 9_nnet测试指引
category: app
typora-root-url: ../../..
---

### 自动无感切换功能测试

nnet会定时监控当前使用的线路质量，在某条线路质量不好时，会自动切换到其他线路。如果是udp协议的两条线路切换，对于用户是无感的：即连接不会中断，切换前后用户指挥感觉网络突然变好了。

测试过程：

1、先让客户端正常通过nnet连接服务端，此时服务端可以查到客户端连接所用的代理线路，假设使用的代理IP为：10.10.10.10。
2、客户端通过系统网络监控工具、抓包工具等，能观察客户端到代理10.10.10.10的连接情况。可用工具列举如下：

* PC：可以使用资源监视器、processMonitor；或者抓包工具wireshark、fiddler。
* android：adb连接后，上传tcpdump抓包；或者手机使用PC热点，到PC上抓包。
* iOS：在mac上使用rvictrl命令将iOS设备网络请求影视到mac上的一个虚拟网卡上，再通过wireshark对虚拟网卡抓包；或者手机使用PC热点，到PC上抓包。

3、服务端单独对代理IP设置丢包，模拟代理线路网络变差：

```shell
sudo iptables -I INPUT -s 10.10.10.10 -m statistic --mode random --probability 0.5 -j DROP
```

4、服务端设置好丢包率后，客户端注意观察：

* 游戏是否因为丢包率设置后变卡了？
* 游戏内心跳延迟如何，延迟是否明显变高？
* 观察客户端到代理10.10.10.10的连接情况，是否自动切换了连接？
* 确认连接切换后，再看看游戏内心跳延迟是否恢复？



### 自动切到保底TCP连接功能测试

nnet优先使用UDP协议进行数据传输，UDP协议对于抗丢包、改善延迟效果比较好。但运营商网络中UDP协议流量优先级会低于TCP协议流量，导致某些网络场景下UDP协议不可用，但仍能正常使用TCP协议。因此，nnet内会自动探测UDP协议不可用的情况，将连接切换到TCP协议。

测试过程：

1、先让客户端正常通过nnet连接服务端，此时服务端可以查到客户端连接所用的代理线路，假设使用的代理IP为：10.10.10.10。
2、客户端通过系统网络监控工具、抓包工具等，能观察客户端到代理10.10.10.10的连接情况，并且确认当前使用的是UDP协议进行连接。
3、服务端单独对nnet监听端口设置屏蔽UDP协议包、允许TCP协议包，这里假设nnet监听端口为`12345`，设置指令如下：

```shell
sudo iptables -I INPUT -p udp --dport 12345 -j DROP
```

4、服务端设置屏蔽UDP协议包后，客户端注意观察：

* 游戏是否卡住了？（由于直接掐断原连接，所有数据包传输失败，游戏应该卡住）
* 游戏内心跳延迟如何，延迟是否明显变高？
* 观察客户端程序到代理10.10.10.10的UDP连接情况，是否已经断开？
* 观察客户端程序是否建立到新的TCP代理连接？
* 确认连接切换后，再看看游戏内心跳延迟是否恢复？

5、服务端确认客户端连接切换完毕，并正常使用TCP代理连上服务端。
6、服务端继续对nnet监听端口设置屏蔽TCP协议包、允许UDP协议包，用于测试TCP连接异常后，能否切回UDP连接。设置指令如下：

```shell
#允许UDP协议
sudo iptables -D INPUT -p udp --dport 12345 -j DROP
#屏蔽TCP协议
sudo iptables -I INPUT -p tcp --dport 12345 -j DROP
```

7、服务端设置屏蔽UDP协议包后，客户端注意观察：

* 游戏是否卡住了？（由于直接掐断原连接，所有数据包传输失败，游戏应该卡住）
* 游戏内心跳延迟如何，延迟是否明显变高？
* 观察客户端程序到代理的TCP连接情况，是否已经断开？
* 观察客户端程序是否建立到新的UDP代理连接？
* 确认连接切换后，再看看游戏内心跳延迟是否恢复？