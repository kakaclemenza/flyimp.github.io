---
layout: post
title: Xxmygw与其测试开发
category: coder
---

## Xxmygw测试实践之路
XXMYGW是啥? 大名鼎鼎的多益网关都不知道, out了

为啥要测试? 当然是想偷懒啦!

我能收获啥? 鄙人啥都没有, 穷的只剩下一堆干货了.

如果你想更多的了解XXMYGW项目, 抑或是为了给自己的项目引入测试框架, 简化开发维护流程等等, 欢迎在分享会上和我一起探讨.

### Xxmygw是啥?

> 电信与联通之间高延迟不是故意设置的。首先，运营商相互之间通信的话网络数据会经 过更多的环节，比如要统计流量或时间（涉及到网间结算）、数据会经过一些防火墙等。每多一道环节、延迟肯定会相应增加一点。如果是自己内部通信的话，数据肯定不会经过这么多环节。周尚勋的比喻比较恰当。另外，运营商之间的互联带宽不够也是个原因。现在网速越来越快，相应的网络流量也增加了很多，因此各个网络节点之间的链路需要更大的带宽。运营商自己内部链路扩容比较积极，因为是自己修路自己用。比如我在的县级公司，为了保证IPTV的业务质量，流量50%都不到就扩链路了。但运营商之间链路扩容相当于是自己修了路但要给别人用，所以大家对此都不太积极。ps：物理距离不是问题。我记得2010年时ping http://google.com延迟稳定在37ms，那距离跨越了太平洋，肯定比南电信北联通的物理距离长。当然现在google在大陆已经被gfw整得半死不活了，这个倒是有关部门故意设置的。
> from 知乎

没有xxmygw, 与xxmygw作为加速器的功能特性  

如何抗DDOS

### 测试: 为什么要做测试
Old:
* 每个功能的每个要点调试, 都要先跑一遍程序, 输出到控制台或日志, 死死盯着屏幕信息进行检验.
* 遇到bug, 修复bug, 为了避免影响到前面的要点, 还是要逐一检查
* 下次别的同事难以察觉的动到了我的代码, 但他并不知道, 只是做了他的代码调试...
* 尽管这些动作好了, 我心为何仍忐忑? (我们在写代码的时候已经固化了思维, 测试的要点可能已经偏离了需求) <瑟瑟发抖图>

New:
* 编码前理解需求, 将现实输入与期望输出固化进单元测试代码, 测试代码只要告诉我OK or not
* 频繁测试, 如果有bug, 源头极大可能是在新加入的代码, 由于记忆犹新, 可瞬间定位bug, 再跑测试用例
* 想坑我, 没那么容易! 你跑不通我的测试用例.
* 所有测试用例已跑通, 程序编写即可明确的结束, <我已经没什么好害怕的了>

> 一套测试就是一个强大的bug侦测器, 能够大大缩减查找bug所需要的时间  
> --<重构: 改善既有代码的设计[高清版]>

哪里需要测试:
* 极限编程[XP]: 测试能帮助XP者更快速的前进
* 重构
* 持续集成, 持续交付, 持续部署

测试种类:
* 单元测试
* 功能测试
* 性能测试(压测)

以下非特别说明的"测试"均指"单元测试"


我写了项目的第一行单元测试代码.

"我相信每个人都可以从编写自我测试代码中受益"



### 我如何搭建这样一个测试框架

测试用例独立性: 每次测试先调用 setUp() 然后运行你编写的测试用例, 最后运行 tearDown()进行清理, 这保证了测试用例之间是彼此隔离的 



### 如何写测试
在搭建好的测试框架基础上, 编写测试用例就变得很简单了. 你可以拷贝一个已有的测试文件, 按照相应的命名规范修改, 加上自己的特殊的测试需求即可. 但请注意以下的一些要点或技巧:

#### 撰写测试代码的最佳时机是在开始编程之前
* 我写的东西究竟要做什么
* 把注意力集中于接口而非实现.
* 明确的结束目标: 一旦测试代码正常运行, 工作即可结束
#### 保证所有测试完全自动化, 最终只要显示 OK 与否
#### 测试应该对应着具体功能, 针对的是该功能的任何一种可能失败的情况
#### setUp() 与 tearDown()
* 我会在 setUp()中生成一些对象, 在tearDown()中做一些清理工作, 如关闭文件等

#### 编写测试代码时, 往往先造成失败, 如构造错误期望值.
* 这是为了证明, 测试机制确实可以运行, 并测试着它应该测试的东西
* 调bug时, 首先构造单元测试以暴露bug

#### 集中测试火力的地方
* 测试你最担心出错的部分.
* 边界条件: 第一, 倒一, 倒二, 空
* 异常声明: 程序无法处理的错误是否能如期被暴露出来



### 使用discover或suite组织测试用例

* discover方式

  discover(start_dir, pattern='test_*.py',top_level_dir=None)

  找到指定目录下所有测试模块，并可**递归**查到子目录下的测试模块，只有匹配到文件名时才加载

  start_dir：要测试的模块名或测试用例目录

  pattern='test*.py'：表示用例文件名的匹配原则。此处匹配以“test”开头的.py 类型的文件，* 表示任意多个字符

  top_level_dir= None 测试模块的顶层目录，如果没有顶层目录，默认为None

  ```shell
  import unittest
  
  test_dir = './'
  #定义测试目录为当前目录
  discover = unittest.defaultTestLoader.discover(test_dir,pattern='test*.py')
  
  if __name__ == '__main__':
      runner = unittest.TextTestRunner()
      runner.run(discover)
  ```

  discover()方法会自动根据测试目录test_dir 匹配查找测试用例文件，并将查找到的测试用例组装到测试套件中，因此，可以直接通过run()方法执行discover，大大简化了测试用例的查找与执行

  **用例执行的顺序**
  unittest 框架默认根据ASCII码的顺序加载测试用例，数字与字母的顺序为：0~9，A~Z,a~z 
  如果要让某个测试用例先执行，不能使用默认的main()方法，需要通过TestSuite类的addTest()方法按照一定的顺序来加载

* suite方式



### 使用mock提升测试用例能力

### 规范化->自动化->智能化
如果你的项目代码还处在经常被莫名奇妙的bug困扰, 经常受部署中的误操作而影响, 那么, 规范化你们的编码和部署操作, 编写你们的单元测试代码, 并开始重构提升效率吧.
如果你的项目已经有比较完善的测试体系与规范, 加入自动化系统, 让代码得以轻松部署发布, 能够快速出错, 快速迭代.
进一步的, 我们会期望正式环境中的代码能够智能的规避出现的严重错误, 并自动回退到稳定版本, 将bug的详细报告通知到相关人员进行维护.

如果这一切都进行的十分理想了, 那么, 你可以开启一个新的项目了. (因为现有的项目已经不怎么会占用你的开发维护时间, 你可以化更多的时间在设计, 优化, 展望上面)

### jenkins自动化

jenkins实际上是从给定的git/svn路径, 定时拉取代码, 并按照指定的动作(如执行一系列shell命令). 一般执行动作填写运行单元测试命令. 这样jenkins就会完成自动测试动作. 当测试完成, 可以配置触发下一个事件, 该事件可以是构建部署到生产环境, 这样就实现了自动部署.

具体的搭建过程比较简单, 参见:

https://www.jianshu.com/p/caa136e191cd

http://mainframer.github.io/articles/Python%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90.html

### 谢谢





### 关于用户运营商相关问题

* 联通和铁通: 铁通以前是个单独的通讯公司，前几年重组把铁通划在了中国移动旗下，而把网通划在中国联通旗下，把中国联通的CDMA网划在中国电信旗下，这样以来，以前的，中移动，中联通，中电信，铁通，网通共五家通讯公司重组成三家，这样以来每家的业务都包含了固话，无线网络，宽带，说是能更好的竞争



### 关于nat.sh配置文件自动下发的构思

(1)中心服维护, 对于注册的游戏服, 唯一对应了端口编号, 形成端口编号数据列表. 这样, 增删游戏服实际上就是对于端口编号占用的更改

(2)PS连上中心服, 上报了自己的ip, 中心服则基于端口编号数据列表为其生成nat.sh, 下发给PS做配置

(3)端口编号数据列表需要通过一致性算法在多个中心服节点间维持一致.